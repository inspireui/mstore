"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,r)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProductDetailsSectionDescriptionBlockEdit=void 0;const classnames_1=__importDefault(require("classnames")),components_1=require("@wordpress/components"),data_1=require("@wordpress/data"),element_1=require("@wordpress/element"),i18n_1=require("@wordpress/i18n"),icons=__importStar(require("@wordpress/icons")),block_templates_1=require("@woocommerce/block-templates"),navigation_1=require("@woocommerce/navigation"),tracks_1=require("@woocommerce/tracks"),core_data_1=require("@wordpress/core-data"),block_slot_fill_1=require("../../../components/block-slot-fill"),validation_context_1=require("../../../contexts/validation-context"),constants_1=require("../../../constants"),use_error_handler_1=require("../../../hooks/use-error-handler"),wooIcons=__importStar(require("../../../icons")),is_product_form_template_system_enabled_1=__importDefault(require("../../../utils/is-product-form-template-system-enabled")),use_product_manager_1=require("../../../hooks/use-product-manager");function ProductDetailsSectionDescriptionBlockEdit({attributes:e,clientId:t,context:{selectedTab:o}}){var n;const r=(0,block_templates_1.useWooBlockProps)(e),{getProductErrorMessageAndProps:c}=(0,use_error_handler_1.useErrorHandler)(),{productTemplates:a,productTemplate:i}=(0,data_1.useSelect)((e=>{const{getEditorSettings:t}=e("core/editor");return t()})),[l,s]=a.reduce((([e,t],o)=>(o.isSelectableByUser&&(o.layoutTemplateId?e.push(o):t.push(o)),[e,t])),[[],[]]),_=(0,core_data_1.useEntityId)("postType","product"),[d]=(0,core_data_1.useEntityProp)("postType","product","status"),{validate:u}=(0,validation_context_1.useValidations)(),{editEntityRecord:m,saveEditedEntityRecord:p,saveEntityRecord:f}=(0,data_1.useDispatch)("core"),{createSuccessNotice:v,createErrorNotice:E}=(0,data_1.useDispatch)("core/notices"),w=(0,data_1.useSelect)((e=>{const{getBlockRootClientId:o}=e("core/block-editor");return o(t)}),[t]),[g,y]=(0,element_1.useState)(),h=(0,data_1.useSelect)((e=>(0,is_product_form_template_system_enabled_1.default)()&&e("core").getEntityRecords("postType","product_form",{per_page:-1})||[]),[]),{isSaving:k}=(0,data_1.useSelect)((e=>{const{isSavingEntityRecord:t}=e("core");return{isSaving:t("postType","product",_)}}),[_]);if(w)return(0,element_1.createElement)(block_slot_fill_1.BlockFill,{name:"section-description",slotContainerBlockName:"woocommerce/product-section"},(0,element_1.createElement)("div",{...r},(0,element_1.createElement)("p",null,(0,element_1.createInterpolateElement)((0,i18n_1.__)("This is a <ProductTemplate />.","woocommerce"),{ProductTemplate:(0,element_1.createElement)("span",null,null===(n=null==i?void 0:i.title)||void 0===n?void 0:n.toLowerCase())})),(0,element_1.createElement)(components_1.Dropdown,{focusOnMount:!0,popoverProps:{placement:"bottom-start"},renderToggle:({isOpen:e,onToggle:t})=>(0,element_1.createElement)(components_1.Button,{"aria-expanded":e,variant:"link",onClick:C(e,t)},(0,element_1.createElement)("span",null,(0,i18n_1.__)("Change product type","woocommerce"))),renderContent:({onClose:e})=>(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-details-section-description__dropdown components-dropdown-menu__menu"},(0,element_1.createElement)(components_1.MenuGroup,null,l.map(T(e))),(0,is_product_form_template_system_enabled_1.default)()&&(0,element_1.createElement)(components_1.MenuGroup,null,h.map((t=>(0,element_1.createElement)(components_1.MenuItem,{key:t.id,icon:S("external"),info:t.excerpt.raw,iconPosition:"left",onClick:e},t.title.rendered)))),s.length>0&&(0,element_1.createElement)(components_1.MenuGroup,null,(0,element_1.createElement)(components_1.Dropdown,{popoverProps:{placement:"right-start"},renderToggle:({isOpen:e,onToggle:t})=>(0,element_1.createElement)(components_1.MenuItem,{"aria-expanded":e,icon:S("chevronRight"),iconPosition:"right",onClick:t},(0,element_1.createElement)("span",null,(0,i18n_1.__)("More","woocommerce"))),renderContent:()=>(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-details-section-description__dropdown components-dropdown-menu__menu"},(0,element_1.createElement)(components_1.MenuGroup,null,s.map(T(e))))})))}),Boolean(g)&&(0,element_1.createElement)(components_1.Modal,{title:(0,i18n_1.__)("Change product type?","woocommerce"),className:"wp-block-woocommerce-product-details-section-description__modal",onRequestClose:()=>{y(void 0)}},(0,element_1.createElement)("p",null,(0,element_1.createElement)("b",null,(0,i18n_1.__)("This product type isn’t supported by the updated product editing experience yet.","woocommerce"))),(0,element_1.createElement)("p",null,(0,i18n_1.__)("You’ll be taken to the classic editing screen that isn’t optimized for commerce but offers advanced functionality and supports all extensions.","woocommerce")),(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-details-section-description__modal-actions"},(0,element_1.createElement)(components_1.Button,{variant:"secondary","aria-disabled":k,onClick:()=>{k||y(void 0)}},(0,i18n_1.__)("Cancel","woocommerce")),(0,element_1.createElement)(components_1.Button,{variant:"primary",isBusy:k,"aria-disabled":k,onClick:async function(){var e,t;try{if(k)return;const{id:o,productData:n}=g;await u(n);const r=null!==(e=await p("postType","product",_,{throwOnError:!0}))&&void 0!==e?e:{id:_},c=null!==(t=null==n?void 0:n.meta_data)&&void 0!==t?t:[];await f("postType","product",{...r,...n,meta_data:[...c,{key:"_product_template_id",value:o}]},{throwOnError:!0}),v((0,i18n_1.__)("Product type changed.","woocommerce")),(0,tracks_1.recordEvent)("product_template_changed",{source:constants_1.TRACKS_SOURCE,template:o}),window.location.href=(0,navigation_1.getNewPath)({},`/product/${_}`)}catch(e){const{message:t,errorProps:n}=c((0,use_product_manager_1.errorHandler)(e,d),o);E(t,n)}}},(0,i18n_1.__)("Change","woocommerce"))))));function b(e,t){return async function(){var n;try{if((0,tracks_1.recordEvent)("product_template_selector_selected",{source:constants_1.TRACKS_SOURCE,selected_template:e.id,unsupported_template:!e.layoutTemplateId}),!e.layoutTemplateId)return y(e),void t();await u(e.productData);const o=null!==(n=e.productData.meta_data)&&void 0!==n?n:[];await m("postType","product",_,{...e.productData,meta_data:[...o,{key:"_product_template_id",value:e.id}]}),await p("postType","product",_,{throwOnError:!0}),v((0,i18n_1.__)("Product type changed.","woocommerce")),(0,tracks_1.recordEvent)("product_template_changed",{source:constants_1.TRACKS_SOURCE,template:e.id})}catch(e){const{message:t,errorProps:n}=c((0,use_product_manager_1.errorHandler)(e,d),o);E(t,n)}t()}}function S(e,t){if(!e)return;const{Icon:o}=icons;let n;if(/^https?:\/\//.test(e))n=(0,element_1.createElement)("img",{src:e,alt:t});else{if(!(e in icons)&&!(e in wooIcons))return;n=icons[e]||wooIcons[e]}return(0,element_1.createElement)(o,{icon:n,size:24})}function T(e){return function(t){var o;const n=(null==i?void 0:i.id)===t.id;return(0,element_1.createElement)(components_1.MenuItem,{key:t.id,info:null!==(o=t.description)&&void 0!==o?o:void 0,isSelected:n,icon:n?S("check"):S(t.icon,t.title),iconPosition:"left",role:"menuitemradio",onClick:b(t,e),className:(0,classnames_1.default)({"components-menu-item__button--selected":n})},t.title)}}function C(e,t){return function(){t(),e||(0,tracks_1.recordEvent)("product_template_selector_open",{source:constants_1.TRACKS_SOURCE,supported_templates:l.map((e=>e.id)),unsupported_template:s.map((e=>e.id))})}}}exports.ProductDetailsSectionDescriptionBlockEdit=ProductDetailsSectionDescriptionBlockEdit;